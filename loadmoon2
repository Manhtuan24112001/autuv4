fask = task
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local AllIDs = {}
local actualHour = os.date("!*t").hour

-- Đọc lịch sử server đã vào
local success = pcall(function()
	AllIDs = HttpService:JSONDecode(readfile("Gomoonsever.json"))
end)

if not success then
	table.insert(AllIDs, actualHour)
	writefile("Gomoonsever.json", HttpService:JSONEncode(AllIDs))
end

-- Hàm kiểm tra pha mặt trăng
local function GetMoonPhase()
	local moonTextures = {
		["http://www.roblox.com/asset/?id=9709149431"] = "Full Moon 🌕",
		["http://www.roblox.com/asset/?id=9709149052"] = "87,5%",
		["http://www.roblox.com/asset/?id=9709143733"] = "75%",
		["http://www.roblox.com/asset/?id=9709150401"] = "62,5%",
		["http://www.roblox.com/asset/?id=9709135895"] = "50%",
		["http://www.roblox.com/asset/?id=9709139597"] = "37,5%",
		["http://www.roblox.com/asset/?id=9709150086"] = "25%",
		["http://www.roblox.com/asset/?id=9709149680"] = "12,5%"
	}

	local textureId = game:GetService("Lighting").Sky.MoonTextureId
	if moonTextures[textureId] then
		print("🌙 Pha mặt trăng hiện tại: " .. moonTextures[textureId])
		return moonTextures[textureId]
	else
		print("🌙 Không xác định được pha mặt trăng")
		return nil
	end
end

function TPFromSavedJob()
	local success, content = pcall(function()
		return readfile("helpfullmoon.json")
	end)

	if success and content and content ~= "" then
		local data = HttpService:JSONDecode(content)
		if typeof(data) == "table" and #data > 0 then
			local job = data[1]
			local jobId = tostring(job.jobId)
			local placeId = tonumber(job.placeId)
			local playerCount = tonumber(job.playerCount or 0)
			local maxPlayers = 12

			local isNew = true
			local num = 0

			for _, existing in pairs(AllIDs) do
				if num ~= 0 then
					if jobId == tostring(existing) then
						isNew = false
					end
				else
					if tonumber(actualHour) ~= tonumber(existing) then
						pcall(function()
							delfile("NotSameServers2.json")
							AllIDs = {}
							table.insert(AllIDs, actualHour)
						end)
					end
				end
				num = num + 1
			end

			-- Kiểm tra Full Moon
			local moonPhase = GetMoonPhase()

			if isNew and playerCount < maxPlayers and moonPhase == "Full Moon 🌕" then
				print("✅ Đang tiến hành join server Full Moon...")
				table.insert(AllIDs, jobId)
				fask.wait()

				pcall(function()
					writefile("Gomoonsever.json", HttpService:JSONEncode(AllIDs))
					fask.wait()

					local args = {
						[1] = "teleport",
						[2] = jobId
					}
					game:GetService("ReplicatedStorage").__ServerBrowser:InvokeServer(unpack(args))
				end)

				fask.wait(0.5)
			else
				print("⏩ Bỏ qua do không phải Full Moon hoặc server đã vào.")
			end
		else
			warn("⚠️ Dữ liệu trong helpfullmoon.json không hợp lệ.")
		end
	else
		warn("❌ Không thể đọc file helpfullmoon.json.")
	end
end

-- Gọi liên tục để kiểm tra và join nếu phù hợp
fask.spawn(function()
	while true do
		pcall(TPFromSavedJob)
		fask.wait(5)
	end
end)
